<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>{{ title }} — 미리보기</title>
<style>
  /* 리셋 & 기본 */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: "Noto Serif CJK KR", "Batang", serif;
    background: #f5f5f0;
    color: #333;
  }

  /* 상단 툴바 */
  .toolbar {
    position: sticky; top: 0; z-index: 100;
    display: flex; align-items: center; gap: 12px;
    padding: 10px 20px;
    background: #2c2c2c; color: #eee;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,.2);
  }
  .toolbar .title { font-weight: 700; font-size: 16px; margin-right: auto; }
  .toolbar select {
    padding: 4px 8px; border-radius: 4px; border: 1px solid #555;
    background: #3a3a3a; color: #eee; font-size: 13px;
  }
  .toolbar .status {
    width: 8px; height: 8px; border-radius: 50%;
    background: #4caf50; flex-shrink: 0;
  }
  .toolbar .status.stale { background: #ff9800; }

  /* 레이아웃 */
  .layout { display: flex; min-height: calc(100vh - 44px); }

  /* 사이드바 (챕터 네비) */
  .sidebar {
    width: 220px; flex-shrink: 0;
    background: #fafaf5; border-right: 1px solid #ddd;
    padding: 16px 0; overflow-y: auto;
    font-size: 13px;
  }
  .sidebar h3 { padding: 0 16px 8px; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: .5px; }
  .sidebar a {
    display: block; padding: 6px 16px;
    color: #444; text-decoration: none;
    border-left: 3px solid transparent;
    transition: all .15s;
  }
  .sidebar a:hover { background: #eee; }
  .sidebar a.active { border-left-color: #2196f3; color: #2196f3; font-weight: 600; }
  .sidebar .chars { color: #aaa; font-size: 11px; margin-left: 4px; }

  /* 본문 */
  .content {
    flex: 1; padding: 40px;
    display: flex; justify-content: center;
  }
  .page {
    width: 100%; max-width: 720px;
    background: #fff;
    padding: 60px 50px;
    box-shadow: 0 1px 12px rgba(0,0,0,.08);
    border-radius: 2px;
    line-height: 1.9;
  }

  /* 판형별 CSS 오버라이드 */
  {{ css }}

  /* 미리보기 전용 보정 */
  @media screen {
    .page { font-size: 15px; }
    .page h1 { page-break-after: auto; margin-top: 1em; }
  }

  .chapter { margin-bottom: 3em; }
  .chapter + .chapter { border-top: 1px solid #eee; padding-top: 2em; }

  /* 반응형 */
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .content { padding: 16px; }
    .page { padding: 24px 20px; }
  }
</style>
</head>
<body>

<div class="toolbar">
  <span class="title">{{ title }}</span>
  <label>
    판형:
    <select id="paper-select">
      {% for key, info in paper_sizes.items() %}
      <option value="{{ key }}" {% if key == current_paper %}selected{% endif %}>{{ info.label }}</option>
      {% endfor %}
    </select>
  </label>
  {% if single_chapter %}
  <a href="/preview/{{ project_id }}?paper={{ current_paper }}" style="color:#90caf9;text-decoration:none;">← 전체 보기</a>
  {% endif %}
  <span class="status" id="poll-status" title="자동 새로고침 활성"></span>
</div>

<div class="layout">
  <nav class="sidebar">
    <h3>챕터</h3>
    {% for ch in chapter_list %}
    <a href="/preview/{{ project_id }}/{{ ch.number }}?paper={{ current_paper }}"
       {% if single_chapter == ch.number %}class="active"{% endif %}>
      {{ ch.number }}장 <span class="chars">{{ ch.chars }}자</span>
    </a>
    {% endfor %}
  </nav>

  <main class="content">
    <div class="page">
      {{ body_html | safe }}
    </div>
  </main>
</div>

<script>
(function() {
  // 판형 변경
  document.getElementById('paper-select').addEventListener('change', function() {
    var url = new URL(window.location);
    url.searchParams.set('paper', this.value);
    window.location.href = url.toString();
  });

  // 자동 새로고침 (5초 폴링)
  var currentHash = "{{ content_hash }}";
  var dot = document.getElementById('poll-status');

  setInterval(function() {
    fetch('/preview/{{ project_id }}/hash')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.hash && data.hash !== currentHash) {
          dot.classList.add('stale');
          window.location.reload();
        }
      })
      .catch(function() {});
  }, 5000);
})();
</script>

</body>
</html>
